# CustopmVisionでExportしたモデルをTensorflowLite用に変換するサンプル

変換処理本体 ＆ 変換モデルデータ格納
変換したモデルはCPUで実行するモデルだが、コンパイルすればEdge-TPUでも使用できる。  
変換処理後、変換したtfliteファイルを``edgetpu_compiler``でコンパイルして Edge-TPU 用ファイルを出力する。    
Edge-TPU用モデルは ファイル名本体末尾に``_edgetpu``付加されたファイル。

## ディレクトリ構成

| ディレクトリ           | 内容                                                            |
|------------------------|-----------------------------------------------------------------|
| run.sh                 | 変換処理実行スクリプト                                          |  
| saved_model2tflite.py  | 変換処理本体(Saved Model → tflite)                             |
| frozen_model2tflite.py | 変換処理本体(Frozen Model → tflite)                            |
| data                   | 整数量子化キャリブレーション用入力ファイル 格納用ディレクトリ   |

### 整数量子化キャリブレーション用入力ファイル
整数量子化処理を行った場合、誤差を低減するため、キャリブレーションを行う。  
そのための画像ファイルを用意する。画像ファイルは何でも良いが、CustomVisionで学習に使用したファイルをdetaディレクトリに格納しておけば良いと思う。  
学習処理とは異なり、実行時間はそんなにかからない。    

## 変換処理プログラム実行方法

run.shの以下のパラメータを変更して、run.shを実行する

```
sh run.sh [frozen | saved] [*2tfliteへ設定するオプション]
```
### run.sh のコマンドラインパラメータ
| パラメータ                   | 内容                                                 |
|------------------------------|------------------------------------------------------|
| frozen                       | Frozen Model から変換する                            |
| saved                        | Saved Model から変換する                             |
| *2tfliteへ設定するオプション | --quantize [weight] [integer] が指定できる           | 

※ パラメータ省略時は frozen が指定されたものとして動作する

### saved modelから変換する場合のパラメータ
| 変数              | 内容                                                            |
|-------------------|-----------------------------------------------------------------|
| SAVED_DIR         | CustomVisionでエクスポートしたSaved Modelを格納したディレクトリ |
| OUTPUT_SAVED_FILE | 出力ファイル                                                    |
| WIDTH             | 入力モデルの幅                                                  |
| HIGHT             | 入力モデルの高さ                                                |

### frozen modelから変換する場合のパラメータ
| 変数               | 内容                                                             |
|--------------------|------------------------------------------------------------------|
| FROZEN_DIR         | CustomVisionでエクスポートしたFrozen Modelを格納したディレクトリ |
| FROZEN_FILE        | Frozen Modelのファイル名                                         |
| OUTPUT_FROZEN_FILE | 出力ファイル                                                     |
| INPUT_TENSORS      | 入力ノードの名前                                                 |
| OUTPUT_TENSORS     | 出力ノードの名前                                                 |

### 共通パラメータ
| 変数               | 内容                                                             |
|--------------------|------------------------------------------------------------------|
| DATA_DIR           | 整数量子化キャリブレーション用入力ファイル 格納ディレクトリ      |  





**Tensorflow 1.15**が使用できるpythonの実行環境で実行すること。

